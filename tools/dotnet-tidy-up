#!/bin/bash

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m'
BOLD='\033[1m'

ALL_CS_FILES_CACHE=""

RUN_FIX_FILES_NAMES=false
RUN_FIX_NAMESPACES=false

show_help() {
    echo -e "${BOLD}${WHITE}.NET Project Tidy Up Tool${NC}"
    echo ""
    echo "Usage: dotnet-tidy-up [OPTIONS]"
    echo ""
    echo "Options:"
    echo -e "  ${GREEN}--filenames${NC}       Fix file names to match type names"
    echo -e "  ${GREEN}--namespaces${NC}      Fix namespaces based on folder structure"
    echo -e "  ${GREEN}--all${NC}             Run all steps (default if no option specified)"
    echo -e "  ${GREEN}-h, --help${NC}        Show this help message"
    echo ""
    echo "Examples:"
    echo "  dotnet-tidy-up                    # Run all steps"
    echo "  dotnet-tidy-up --filenames        # Only fix file names"
    echo "  dotnet-tidy-up --filenames --namespaces  # Fix names and namespaces"
    echo ""
}

FixFileNamesInconsistencies() {
    types=("class" "interface" "record" "enum" "struct")
    types_pattern=$(IFS='|'; echo "${types[*]}")

    modifiers=("public" "private" "internal" "protected" "abstract" "sealed" "static" "partial")
    modifiers_pattern=$(IFS='|'; echo "${modifiers[*]}")

    local changes_count=0
    
    local files="$ALL_CS_FILES_CACHE"

    local temp_file=$(mktemp)
    
    echo "$files" | xargs -P 8 -I {} bash -c '
        file="{}"
        
        content=$(head -n 20 "$file" 2>/dev/null)
        
        if echo "$content" | grep -q "<auto-generated />"; then
            exit 0
        fi
        
        dir=$(dirname "$file")
        current_filename=$(basename "$file" .cs)
        
        type_name=$(echo "$content" | grep -oP "^\s*(('"$modifiers_pattern"')\s+)*('"$types_pattern"')\s+\K[A-Za-z_][A-Za-z0-9_]*" | head -n 1)

        if [ -n "$type_name" ] && [ "$type_name" != "$current_filename" ]; then
            new_file="$dir/$type_name.cs"
            
            if [ ! -e "$new_file" ] || [ "$file" = "$new_file" ]; then
                echo "RENAME|$file|$new_file"
            fi
        fi
    ' > "$temp_file"
    
    while IFS='|' read -r action old_file new_file; do
        if [ "$action" = "RENAME" ]; then
            echo -e "  ${YELLOW}[!]${NC} ${GRAY}$old_file${NC} ${WHITE}â†’${NC} ${GREEN}$new_file${NC}"
            mv -f "$old_file" "$new_file"
            ((changes_count++))
        fi
    done < "$temp_file"
    
    rm -f "$temp_file"

    echo -e "\n${BLUE}[+]${NC} File names fixed: ${BLUE}$changes_count${NC} \n"
    
    return $changes_count
}

get_expected_namespace() {
    local file="$1"
    local project_dir="$2"
    local project_name="$3"
    
    local file_dir=$(dirname "$file")
    local rel_path=$(realpath --relative-to="$project_dir" "$file_dir")
    
    if [ "$rel_path" = "." ]; then
        echo "$project_name"
    else
        echo "$project_name.${rel_path//\//.}"
    fi
}

FixNamespacesInconsistencies() {
    local changes_count=0

    local csproj_files=$(find . -name "*.csproj" -type f ! -path "*/obj/*" ! -path "*/bin/*")

    if [ -z "$csproj_files" ]; then
        echo "Error: No .csproj files found \n"
        exit 1
    fi

    declare -A namespace_changes

    while IFS= read -r csproj; do
        project_dir=$(dirname "$csproj")
        project_name=$(basename "$csproj" .csproj)
        
        local cs_files=$(echo "$ALL_CS_FILES_CACHE" | grep "^$project_dir/")
        
        local temp_file=$(mktemp)
        echo "$cs_files" | xargs -P 8 -I {} bash -c '
            file="{}"
            project_dir="'"$project_dir"'"
            project_name="'"$project_name"'"
            
            file_content=$(head -n 20 "$file" 2>/dev/null)
            
            if echo "$file_content" | grep -q "<auto-generated />"; then
                exit 0
            fi
            
            rel_path="${file#$project_dir/}"
            rel_path="${rel_path#src/}"
            rel_dir=$(dirname "$rel_path")
            
            if [ "$rel_dir" = "." ]; then
                expected_namespace="$project_name"
            else
                namespace_suffix=$(echo "$rel_dir" | tr "/" ".")
                expected_namespace="$project_name.$namespace_suffix"
            fi
            
            current_namespace=$(echo "$file_content" | grep -oP "^\s*namespace\s+\K([A-Za-z_][A-Za-z0-9_.]*)?(?=\s*[;{])" | head -n 1)
            has_namespace=$(echo "$file_content" | grep -P "^\s*namespace\s+" | head -n 1)
            
            if [ -n "$has_namespace" ]; then
                if [ -z "$current_namespace" ]; then
                    current_namespace=""
                fi
                
                if [ "$current_namespace" != "$expected_namespace" ]; then
                    echo "CHANGE|$file|$current_namespace|$expected_namespace"
                fi
            fi
        ' >> "$temp_file"
        
        while IFS='|' read -r action file current_ns expected_ns; do
            if [ "$action" = "CHANGE" ]; then
                echo -e "     ${YELLOW}[!]${NC} $(basename $file)"
                echo -e "         ${RED}Current:${NC}  ${RED}${current_ns:-<empty>}${NC}"
                echo -e "         ${GREEN}Expected:${NC} ${GREEN}$expected_ns${NC} \n"
                
                if [ -z "$current_ns" ]; then
                    sed -i "s/^\s*namespace\s*;/namespace $expected_ns;/" "$file"
                else
                    local escaped_current=$(echo "$current_ns" | sed 's/[.[\*^$]/\\&/g')
                    sed -i "s/namespace $escaped_current/namespace $expected_ns/" "$file"
                fi

                ((changes_count++))
                
                if [ -n "$current_ns" ]; then
                    namespace_changes["$current_ns"]="$expected_ns"
                fi
            fi
        done < "$temp_file"
        
        rm -f "$temp_file"
    done <<< "$csproj_files"

    for old_ns in "${!namespace_changes[@]}"; do
        new_ns="${namespace_changes[$old_ns]}"
        FixUsingStatements "$old_ns" "$new_ns"
    done

    echo -e "${MAGENTA}[+]${NC} Namespaces fixed: ${MAGENTA}$changes_count${NC}"

    return $changes_count
}

FixUsingStatements() {
    local old_ns="$1"
    local new_ns="$2"
    
    local escaped_old=$(echo "$old_ns" | sed 's/[.[\*^$]/\\&/g')
    local escaped_new=$(echo "$new_ns" | sed 's/[\/&]/\\&/g')
    
    echo "$ALL_CS_FILES_CACHE" | xargs -r grep -l "using $old_ns;" 2>/dev/null | xargs -r sed -i "s/using $escaped_old;/using $escaped_new;/"
}

while [[ $# -gt 0 ]]; do
    case $1 in
        --filenames)
            RUN_FIX_FILES_NAMES=true
            shift
            ;;
        --namespaces)
            RUN_FIX_NAMESPACES=true
            shift
            ;;
        --all)
            RUN_FIX_FILES_NAMES=true
            RUN_FIX_NAMESPACES=true
            shift
            ;;
        -h|--help)
            show_help
            exit 0
            ;;
        *)
            echo -e "${RED}Unknown option: $1${NC}"
            show_help
            exit 1
            ;;
    esac
done

if [ "$RUN_FIX_FILES_NAMES" = false ] && [ "$RUN_FIX_NAMESPACES" = false ]; then
    RUN_FIX_FILES_NAMES=true
    RUN_FIX_NAMESPACES=true
fi

echo "----------------------------------------------------------------"
echo "                  .NET Project Tidy Up Tool"
echo -e "---------------------------------------------------------------- \n"

echo -e "${GRAY}[*] Searching for .cs files...${NC}"
ALL_CS_FILES_CACHE=$(find . -name "*.cs" -type f ! -path "*/obj/*" ! -path "*/bin/*")
echo -e "${GRAY}[*] $(echo "$ALL_CS_FILES_CACHE" | wc -l) files found${NC} \n"

fileNamesInconsistenciesExists=1
namespacesInconsistenciesExists=1

if [ "$RUN_FIX_FILES_NAMES" = true ]; then
    echo -e "${BOLD}${BLUE}[+] Fixing file names...${NC} \n"
    FixFileNamesInconsistencies
    fileNamesInconsistenciesExists=$?
fi

if [ "$RUN_FIX_NAMESPACES" = true ]; then
    echo -e "${BOLD}${MAGENTA}[+] Fixing namespaces...${NC} \n"
    FixNamespacesInconsistencies
    namespacesInconsistenciesExists=$?
fi

echo "----------------------------------------------------------------"

if [ "$fileNamesInconsistenciesExists" -ne 0 ] || [ "$namespacesInconsistenciesExists" -ne 0 ]; then
    echo -e "${BOLD}${YELLOW}[!]${NC} All done! Pay more attention next time, code monkey!${NC} \n"
else
    echo -e "${BOLD}${GREEN}[+]${NC} Perfect! You were paying attention this time!${NC} \n"
fi